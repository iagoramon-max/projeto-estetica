{% load static %}
<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Studio Belleza — Agenda online{% endblock %}</title>

    <!-- CSS local (crie static/css/styles.css se estiver faltando) -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

    <!-- Tailwind fallback -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <style>
      body { background: linear-gradient(180deg, #fffafc 0%, #fff6f8 100%); }
      .main-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 30px rgba(13,12,20,0.06);
        border: 1px solid rgba(0,0,0,0.03);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .brand { display:flex; align-items:center; gap:0.75rem; }
      .brand-logo { width:48px; height:48px; border-radius:12px;
                    background: linear-gradient(180deg, #ff5d9e, #ff3b84);
                    display:flex; align-items:center; justify-content:center; }
      .brand-logo svg { width:26px; height:26px; fill: white; }
      .whatsapp-btn {
        background: linear-gradient(180deg, #ff5d9e, #ff3b84);
        color: white; padding: .6rem 1rem; border-radius: .75rem;
        box-shadow: 0 6px 18px rgba(255,93,158,0.15);
      }
      .content-section { margin-top: 2rem; }
      @media (max-width:768px) {
        .card-header{flex-direction:column; align-items:flex-start; gap:.75rem;}
        .whatsapp-btn{align-self:flex-end;}
        .content-section{margin-top:1.5rem;}
      }

      /* modal quick styles to guarantee it looks ok even without extra CSS */
      .wa-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
      .wa-modal { background:white; border-radius:12px; padding:18px; width:94%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.12); }
      .wa-input { width:100%; padding:.6rem; border-radius:.5rem; border:1px solid #e5e7eb; margin-bottom:.75rem; }
      .btn { padding:.55rem .9rem; border-radius:.6rem; }
      .btn-primary { background:#ec4899; color:white; border:none; }
      .btn-ghost { background:white; border:1px solid #e5e7eb; color:#111827; }
    </style>

    {% block head %}{% endblock %}
  </head>
  <body class="antialiased text-gray-800">
    <main class="max-w-6xl mx-auto p-6">
      <div class="main-card p-6 md:p-8">
        <!-- Cabeçalho -->
        <header class="card-header">
          <div class="brand">
            <div class="brand-logo" aria-hidden="true">
              <!-- SVG silhueta -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 32C132.3 32 32 132.3 32 256s100.3 224 224 224c67.3 0 128.1-27.3 171.5-71.5S480 323.3 480 256 452.7 127.9 408.5 84.5 323.3 32 256 32zm-12 112c22.1 0 40 17.9 40 40 0 12.2-5.5 23.1-14.2 30.3 16.3 5.9 34.2 17.6 48.2 33.7 19.8 22.5 29.3 47.2 29.3 73.9 0 45.9-22.6 86.1-61.3 111.4-6.6 4.3-15.6 2.4-19.9-4.2s-2.4-15.6 4.2-19.9c28.9-18.9 44.9-47.3 44.9-87.2 0-18.3-6.8-35.7-20.3-51.1-11.6-13.1-25.7-22.5-38.4-26.9-4.7-1.6-9.4-2.8-14-3.4-8.8-1.1-15.6-8.6-15.6-17.5V184c0-4.4 1.8-8.6 4.9-11.7s7.3-4.9 11.7-4.9zm-28 80c8.8 0 16 7.2 16 16v8c0 8.8-7.2 16-16 16s-16-7.2-16-16v-8c0-8.8 7.2-16 16-16z"/></svg>
            </div>
            <div>
              <div class="text-xl font-bold text-pink-600">Studio Belleza</div>
              <div class="text-xs text-gray-500">Agenda online · Simulação UNIVESP</div>
            </div>
          </div>

          <a href="https://wa.me/5512991613940?text=Olá!%20Gostaria%20de%20agendar%20um%20horário%20no%20Studio%20Belleza.%20Poderia%20me%20ajudar%3F"
             target="_blank"
             class="whatsapp-btn hover:opacity-95 transition">
            Agende pelo WhatsApp
          </a>
        </header>

        <!-- Conteúdo (index.html injeta aqui) -->
        <section class="content-section">
          {% block content %}{% endblock %}
        </section>
      </div>
    </main>

    <footer class="max-w-6xl mx-auto p-6 text-center text-sm text-gray-400">
      Protótipo para apresentação acadêmica — notificações WhatsApp simuladas.
    </footer>

    <!-- Script: captura cliques em botões de horário e abre modal -->
  <script>
(function(){
  const WA_NUMBER = "5512991613940";

  /* ---- helpers ---- */
  function showTemporaryMessage(text, colorClass = "bg-green-500") {
    const msg = document.createElement("div");
    msg.textContent = text;
    msg.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-5 py-3 text-white font-medium rounded-lg shadow-lg z-[99999] ${colorClass}`;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 5000);
  }

  function getSelectedDayIso(){
    const active = document.querySelector('#days-grid button[aria-pressed="true"], #days-grid button.active, #days-grid button.selected');
    if(active) return active.dataset.iso;
    return null;
  }

  function resetCentralFormAndSelection(){
    // limpar campos centrais
    const centralName = document.querySelector('input[name="client_name"], input#id_client_name, input[placeholder*="Nome"]');
    const centralPhone = document.querySelector('input[name="client_phone"], input#id_client_phone, input[placeholder*="Telefone"]');
    if(centralName) centralName.value = '';
    if(centralPhone) centralPhone.value = '';

    // limpar texto do horário selecionado central (se existir)
    const centralStart = document.querySelector('.confirm-start, .selected-start, #selected-start, .selected-datetime, .confirm-datetime');
    if(centralStart) centralStart.innerText = '';

    // remover seleção visual nos dias
    document.querySelectorAll('#days-grid button.selected, #days-grid button.active, #days-grid button[aria-pressed="true"]').forEach(b=>{
      b.classList.remove('selected','active');
      b.removeAttribute('aria-pressed');
    });

    // remover seleção visual nos horários (botões com data-start)
    document.querySelectorAll('[data-start].slot-selected, [data-start].active').forEach(b=>{
      b.classList.remove('slot-selected','active');
    });
  }

  function refreshSlots(profId){
    // tenta chamar a função fetchSlots definida no index.js (se existir)
    if(typeof fetchSlots === 'function' && (window.selectedDayIso || getSelectedDayIso()) && window.selectedServiceId){
      const dayIso = window.selectedDayIso || getSelectedDayIso();
      fetchSlots(dayIso, window.selectedServiceId, profId || null);
      return;
    }
    // se não existir fetchSlots, tenta clicar no botão já presente
    const sel = document.querySelector('#days-grid button[aria-pressed="true"], #days-grid button.active, #days-grid button.selected') ||
                document.querySelector('#days-grid button[data-iso]');
    if(sel){ sel.click(); return; }
    // fallback
    location.reload();
  }

  /* ---- captura clique em slot (delegation) ---- */
  document.addEventListener('click', function(e){
    // botão com data-start (slots gerados pelo partial)
    const btn = e.target.closest('[data-start]');
    if(!btn) return;

    const startIso = btn.dataset.start || btn.getAttribute('data-start');
    const display = btn.dataset.display || btn.getAttribute('data-display') || btn.innerText.trim();
    const serviceName = btn.dataset.serviceName || btn.getAttribute('data-service-name') || (document.querySelector('.service-item .font-medium')?.innerText || '');
    const serviceId = btn.dataset.serviceId || btn.getAttribute('data-service-id') || window.selectedServiceId || document.querySelector('input[name="service_id"]')?.value || '';
    const professionalId = btn.dataset.professional || btn.getAttribute('data-professional') || window.selectedProfessionalId || document.querySelector('input[name="professional_id"]')?.value || '';

    openBookingModal(startIso, display, serviceName, serviceId, professionalId);
  });


  /* ---- modal + ações ---- */
  function openBookingModal(startIso, displayStr, serviceName, serviceId, professionalId){
    // remove modal antigo
    const old = document.getElementById('wa-modal-wrap'); if(old) old.remove();

    const modal = document.createElement('div');
    modal.id = 'wa-modal-wrap';
    modal.className = 'wa-modal-backdrop';
    modal.innerHTML = `
      <div class="wa-modal" role="dialog" aria-modal="true">
        <h3 style="font-weight:600;margin-bottom:8px">Agendamento — ${displayStr}</h3>
        <input id="wa_name" class="wa-input" placeholder="Seu nome" />
        <input id="wa_phone" class="wa-input" placeholder="Telefone (5511...)" inputmode="tel" />
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
          <button id="wa_cancel" class="btn btn-ghost">Cancelar</button>
          <button id="wa_whats" class="btn btn-primary">Agendar via WhatsApp</button>
          <button id="wa_book" class="btn" style="background:#10B981;color:white;">Reservar no site</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    document.getElementById('wa_cancel').addEventListener('click', ()=> modal.remove());

    async function createBooking(name, phone){
      const form = new FormData();
      form.append('professional_id', professionalId);
      form.append('service_id', serviceId);
      form.append('start', startIso);
      form.append('client_name', name);
      form.append('client_phone', phone);
      return await fetch('/book/', { method:'POST', body: form });
    }

    // WHATSAPP: tenta criar booking e abre wa.me; atualiza UI
    document.getElementById('wa_whats').addEventListener('click', async ()=>{
      const name = document.getElementById('wa_name').value.trim();
      const phone = document.getElementById('wa_phone').value.trim();

      // se sem dados, confirma abertura do wa.me sem registrar
      if(!name && !phone){
        const ok = confirm('Abrir WhatsApp sem registrar no site? (não bloqueará horário no site)');
        if(!ok) return;
        const msg = `Olá! Gostaria de agendar ${serviceName} no dia ${displayStr}.`;
        window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        modal.remove();
        return;
      }

      try{
        const res = await createBooking(name, phone);
        if(res && res.ok){
          // sucesso: bloqueia slot, mostra mensagem e abre wa.me
          resetCentralFormAndSelection();
          showTemporaryMessage("Continue no WhatsApp para finalizar o agendamento", "bg-pink-500");
          modal.remove();

          const message = `Olá! Gostaria de agendar ${serviceName} no dia ${displayStr}. Nome: ${name}. Telefone: ${phone}`;
          window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');

          refreshSlots(professionalId);
        } else if(res && res.status === 409){
          alert('Horário já reservado por outra pessoa.');
          modal.remove();
          refreshSlots(professionalId);
        } else {
          const txt = await (res.text().catch(()=>null));
          alert('Erro ao criar reserva no site: ' + (txt || res.status || 'erro'));
        }
      }catch(err){
        const ok = confirm('Erro ao criar reserva no site. Deseja abrir o WhatsApp mesmo assim?');
        if(ok){
          const message = `Olá! Gostaria de agendar ${serviceName} no dia ${displayStr}. Nome: ${name}. Telefone: ${phone}`;
          window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
          modal.remove();
        }
      }
    });

    // RESERVAR NO SITE (sem abrir WhatsApp)
    document.getElementById('wa_book').addEventListener('click', async ()=>{
      const name = document.getElementById('wa_name').value.trim();
      const phone = document.getElementById('wa_phone').value.trim();
      if(!name || !phone){ alert('Preencha nome e telefone para reservar no site.'); return; }

      try{
        const res = await createBooking(name, phone);
        if(res && res.ok){
          // sucesso: limpar form central, mostrar toast, atualizar slots
          resetCentralFormAndSelection();
          showTemporaryMessage("Agendamento registrado com sucesso!", "bg-green-500");
          modal.remove();
          refreshSlots(professionalId);
        } else if(res && res.status === 409){
          alert('Horário já reservado por outra pessoa.');
          modal.remove();
          refreshSlots(professionalId);
        } else {
          const txt = await (res.text().catch(()=>null));
          alert('Erro ao criar reserva: ' + (txt || res.status || 'erro'));
        }
      }catch(err){
        alert('Falha na conexão: ' + (err.message || err));
      }
    });

  } // end openBookingModal

  // expor para debug (opcional)
  window.openBookingModal = openBookingModal;
  window.refreshSlots = refreshSlots;

})();
</script>



    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>if(window.feather) feather.replace()</script>

    {% block scripts %}{% endblock %}
  </body>
</html>
