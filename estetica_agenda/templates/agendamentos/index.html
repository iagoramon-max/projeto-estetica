{% extends 'agendamentos/base.html' %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- Serviços (coluna 1) -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Serviços</h2>
    <div class="space-y-3" id="services-list">
      {% for s in services %}
      <label class="service-item block p-3 rounded-xl border hover:shadow-sm cursor-pointer flex items-center justify-between"
             data-service-id="{{ s.id }}">
        <div>
          <div class="font-medium">{{ s.name }}</div>
          <div class="text-xs text-gray-500">{{ s.duration_min }} min • R$ {{ s.price }}</div>
        </div>
        <input class="service-radio" type="radio" name="service" value="{{ s.id }}" {% if forloop.first %}checked{% endif %}>
      </label>
      {% endfor %}
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2">Horários</h3>
      <div id="slots" class="min-h-[220px] p-3 border rounded-lg bg-white">
        <div class="text-sm text-gray-400">Escolha um serviço e um dia para ver horários.</div>
      </div>
    </div>
  </section>

  <!-- Calendário (coluna 2) -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Escolha o dia</h2>
    <div class="grid grid-cols-7 gap-2" id="days-grid">
      {% for d in days_info %}
        <button class="day-btn p-2 rounded-lg border text-sm text-center flex flex-col items-center justify-center"
                data-iso="{{ d.iso }}"
                data-date="{{ d.date|date:'Y-m-d' }}">
          <div class="text-xs text-gray-400">{{ d.date|date:"D" }}</div>
          <div class="font-medium">{{ d.date|date:"d" }}</div>
        </button>
      {% endfor %}
    </div>

    <!-- Área de confirmação ÚNICA (coluna central) -->
    <div class="mt-6 p-4 bg-white rounded-lg border">
      <h3 class="font-semibold mb-3">Confirmar agendamento</h3>
      <div class="mb-3">Horário: <strong class="confirm-start">--</strong></div>
      <input type="text" name="client_name" class="w-full p-2 border rounded mb-3 central-name" placeholder="Nome">
      <input type="tel" name="client_phone" class="w-full p-2 border rounded mb-3 central-phone" placeholder="Telefone (55119...)">
      <div class="flex gap-3">
        <button id="central-cancel" class="px-3 py-2 border rounded">Cancelar</button>
        <button id="central-confirm" class="px-4 py-2 bg-pink-600 text-white rounded">Confirmar</button>
      </div>
    </div>
  </section>

  <!-- Coluna direita: (apenas espaço reservado, NÃO repetir confirmação) -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Informações</h2>
    <div class="p-4 border rounded-lg bg-white text-sm text-gray-500">
      Use o calendário e os horários para selecionar um slot. Você pode confirmar aqui ou usar o modal rápido (clicando no horário).
    </div>
  </section>
</div>

<!-- hidden professional id para garantir valor numérico no JS -->
<input type="hidden" id="professional-id" value="{% if professional %}{{ professional.id }}{% endif %}" />
<input type="hidden" id="selected-start-hidden" value="" />

<!-- TOAST area (temporário) -->
<div id="page-toast" style="position:fixed; right:20px; top:20px; z-index:9999; display:none; background:#111827; color:white; padding:12px 16px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.2)"></div>

<script>
/* --- Estado global --- */
window.selectedServiceId = null;
window.selectedDayIso = null;
window.selectedStartIso = null; // guarda o slot selecionado para a confirmação central

/* inicializa selectedServiceId com o radio checado (se houver) */
const checkedService = document.querySelector('.service-radio:checked');
if (checkedService) {
  window.selectedServiceId = checkedService.value;
}

/* pega professional id de forma segura */
const professionalIdRaw = document.getElementById('professional-id')?.value || null;
const professionalId = professionalIdRaw ? professionalIdRaw : null;

/* funçõess utilitárias */
function showToast(text, ms=5000){
  const t = document.getElementById('page-toast');
  t.innerText = text; t.style.display = 'block';
  clearTimeout(t._h); t._h = setTimeout(()=> t.style.display='none', ms);
}
function clearCentralForm(){
  const cs = document.querySelector('.central-name');
  const cp = document.querySelector('.central-phone');
  const csStart = document.querySelector('.confirm-start');
  if(cs) cs.value = '';
  if(cp) cp.value = '';
  if(csStart) csStart.innerText = '--';
  window.selectedStartIso = null;
  document.getElementById('selected-start-hidden').value = '';
}

/* selecionar serviço via click visual */
document.querySelectorAll('.service-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    document.querySelectorAll('.service-item').forEach(i=>i.classList.remove('ring-2','ring-pink-300'));
    item.classList.add('ring-2','ring-pink-300');
    const radio = item.querySelector('.service-radio');
    radio.checked = true;
    window.selectedServiceId = radio.value;
    if(window.selectedDayIso) fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
  });
});

/* dias */
document.querySelectorAll('.day-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('border-pink-600','bg-pink-50'));
    btn.classList.add('border-pink-600','bg-pink-50');
    window.selectedDayIso = btn.dataset.iso;
    if(!window.selectedServiceId){
      alert('Selecione um serviço primeiro');
      return;
    }
    clearCentralForm();
    fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
  });
});

/* delegação de slots: captura clicks em botões gerados dinamicamente */
const slotsContainer = document.getElementById('slots');
slotsContainer.addEventListener('click', (e) => {
  const btn = e.target.closest('.slot-button');
  if(!btn) return;
  // se for ocupado, nada
  if(btn.classList.contains('occupied')) return;
  const start = btn.dataset.start;
  const serviceId = btn.dataset.service;
  const profId = btn.dataset.professional;
  // preencher confirmação central com o horário e valores
  const formatted = new Date(start).toLocaleString('pt-BR');
  const csStart = document.querySelector('.confirm-start');
  if(csStart) csStart.innerText = formatted;
  window.selectedStartIso = start;
  document.getElementById('selected-start-hidden').value = start;
});

/* botão Confirmar (área central) - tenta criar booking via /book/ */
document.getElementById('central-confirm').addEventListener('click', async ()=>{
  const name = document.querySelector('.central-name').value.trim();
  const phone = document.querySelector('.central-phone').value.trim();
  const start = window.selectedStartIso;
  if(!start){ alert('Selecione um horário primeiro'); return; }
  if(!name || !phone){ alert('Preencha nome e telefone'); return; }
  const prof = professionalId;
  const service = window.selectedServiceId;
  const payload = new FormData();
  payload.append('professional_id', prof);
  payload.append('service_id', service);
  payload.append('start', start);
  payload.append('client_name', name);
  payload.append('client_phone', phone);

  try{
    const resp = await fetch('/book/', { method: 'POST', body: payload });
    if(resp.status === 200){
      const data = await resp.json();
      showToast('Agendamento registrado com sucesso', 4000);
      // simular notificação
      await fetch('/notify-whatsapp/', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({booking_id: data.booking.id, to: 'professional'})
      });
      clearCentralForm();
      // atualizar slots
      if(window.selectedDayIso && service) fetchSlots(window.selectedDayIso, service, prof);
      else location.reload();
    } else if(resp.status === 409){
      alert('Horário já reservado por outra pessoa.');
      if(window.selectedDayIso && window.selectedServiceId) fetchSlots(window.selectedDayIso, window.selectedServiceId, prof);
    } else {
      const txt = await resp.text();
      alert('Erro ao criar agendamento: ' + (txt || resp.status));
    }
  }catch(err){
    alert('Erro de conexão: ' + err.message);
  }
});

/* central cancelar */
document.getElementById('central-cancel').addEventListener('click', ()=>{
  clearCentralForm();
});

/* fetchSlots como antes, mas garante class 'occupied' e data-* corretos */
async function fetchSlots(day, serviceId, profId){
  if(!profId && !professionalId){
    document.getElementById('slots').innerHTML = '<div class="text-red-600">Nenhum profissional configurado.</div>';
    return;
  }
  const usedProf = profId || professionalId;
  const url = `/slots/?day=${encodeURIComponent(day)}&service_id=${serviceId}&professional_id=${usedProf}`;
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 8000);

  document.getElementById('slots').innerHTML = '<div class="text-gray-500">Carregando horários...</div>';

  try {
    const resp = await fetch(url, { signal: controller.signal });
    clearTimeout(timeout);
    if(resp.status === 200){
      const html = await resp.text();
      document.getElementById('slots').innerHTML = html;
      // depois de inserir HTML, marcar botões .slot-button para UX
      document.querySelectorAll('#slots .slot-button').forEach(b=>{
        if(b.dataset.available === 'false' || b.classList.contains('occupied')){
          b.classList.add('occupied');
        }
      });
    } else {
      const text = await resp.text();
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários (status ${resp.status}).</div>`;
      console.error('Erro slots:', resp.status, text);
    }
  } catch (err) {
    clearTimeout(timeout);
    if (err.name === 'AbortError') {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Tempo de espera esgotado. Tente novamente.</div>`;
    } else {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários: ${err.message}</div>`;
    }
    console.error('fetchSlots error', err);
  }
}
</script>
{% endblock %}
