{% extends 'agendamentos/base.html' %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Serviços</h2>
    <div class="space-y-3">
      {% for s in services %}
      <label class="block p-3 rounded-xl border hover:shadow-sm cursor-pointer flex items-center justify-between">
        <div>
          <div class="font-medium">{{ s.name }}</div>
          <div class="text-xs text-gray-500">{{ s.duration_min }} min • R$ {{ s.price }}</div>
        </div>
        <input type="radio" name="service" value="{{ s.id }}" {% if forloop.first %}checked{% endif %}
               onclick="fetchSlots('{{ days_info.0.iso }}', {{ s.id }}, {{ professional.id }})">
      </label>
      {% endfor %}
    </div>
  </section>

  <!-- Calendário em grade 7 colunas com badge -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Escolha o dia</h2>
    <div class="grid grid-cols-7 gap-2">
      {% for d in days_info %}
        {% with dt=d.date %}
        <button class="p-2 rounded-lg border text-sm text-center flex flex-col items-center justify-center relative"
                data-iso="{{ d.iso }}"
                onclick="fetchSlots(this.dataset.iso, {{ services.0.id }}, {{ professional.id }})"
                title="{{ d.date|date:'l, d F Y' }}">
          <div class="text-xs text-gray-400">{{ d.date|date:"D" }}</div>
          <div class="font-medium">{{ d.date|date:"d" }}</div>

          {% if d.count > 0 %}
            <span class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs px-2 py-0.5 rounded-full">{{ d.count }}</span>
          {% endif %}
        </button>
        {% endwith %}
      {% endfor %}
    </div>
  </section>

  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Horários</h2>
    <div id="slots" class="min-h-[220px] p-3 border rounded-lg bg-white">
      <div class="text-sm text-gray-400">Escolha um serviço e um dia para ver horários.</div>
    </div>
  </section>
</div>

<script>
/* fetchSlots com timeout de 8s */
async function fetchSlots(day, serviceId, profId){
  const url = `/slots/?day=${encodeURIComponent(day)}&service_id=${serviceId}&professional_id=${profId}`;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 8000);

  try {
    const resp = await fetch(url, { signal: controller.signal });
    clearTimeout(timeout);
    if(resp.status === 200){
      const html = await resp.text();
      document.getElementById('slots').innerHTML = html;
    } else {
      const text = await resp.text();
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários (status ${resp.status}).</div>`;
      console.error('Erro slots:', resp.status, text);
    }
  } catch (err) {
    clearTimeout(timeout);
    if (err.name === 'AbortError') {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Tempo de espera esgotado. Tente novamente.</div>`;
    } else {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários: ${err.message}</div>`;
    }
    console.error('fetchSlots error', err);
  }
}
</script>
{% endblock %}
