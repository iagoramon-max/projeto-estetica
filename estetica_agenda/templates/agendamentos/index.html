{% extends 'agendamentos/base.html' %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- COLUNA ESQUERDA: Serviços (APENAS serviços) -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Serviços</h2>
    <div class="space-y-3" id="services-list">
      {% for s in services %}
      <label class="service-item block p-3 rounded-xl border hover:shadow-sm cursor-pointer flex items-center justify-between"
             data-service-id="{{ s.id }}">
        <div>
          <div class="font-medium">{{ s.name }}</div>
          <div class="text-xs text-gray-500">{{ s.duration_min }} min • R$ {{ s.price }}</div>
        </div>
        <input class="service-radio" type="radio" name="service" value="{{ s.id }}" {% if forloop.first %}checked{% endif %}>
      </label>
      {% endfor %}
    </div>
  </section>

  <!-- COLUNA DO MEIO: Calendário -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Escolha o dia</h2>
    <div class="grid grid-cols-7 gap-2" id="days-grid">
      {% for d in days_info %}
        <button class="day-btn p-2 rounded-lg border text-sm text-center flex flex-col items-center justify-center"
                data-iso="{{ d.iso }}"
                data-date="{{ d.date|date:'Y-m-d' }}">
          <div class="text-xs text-gray-400">{{ d.date|date:"D" }}</div>
          <div class="font-medium">{{ d.date|date:"d" }}</div>
        </button>
      {% endfor %}
    </div>

    <!-- Opcional: área de confirmação central REMOVIDA (não duplicar) -->
  </section>

  <!-- COLUNA DIREITA: Horários (moved here) -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Horários</h2>
    <div id="slots" class="min-h-[220px] p-3 border rounded-lg bg-white">
      <div class="text-sm text-gray-400">Escolha um serviço e um dia para ver horários.</div>
    </div>
  </section>
</div>

<!-- hidden professional id para garantir valor numérico no JS -->
<input type="hidden" id="professional-id" value="{% if professional %}{{ professional.id }}{% endif %}" />

<script>
/* --- Estado global (exposto) --- */
window.selectedServiceId = null;
window.selectedDayIso = null;

/* inicializa selectedServiceId com o radio checado (se houver) */
(function initSelectedService(){
  const checkedService = document.querySelector('.service-radio:checked');
  if (checkedService) window.selectedServiceId = checkedService.value;
})();

/* pega professional id de forma segura */
const professionalIdRaw = document.getElementById('professional-id')?.value || null;
const professionalId = professionalIdRaw ? professionalIdRaw : null;

/* função que abre o modal: definida aqui (global) para sempre existir */
function openBookingModal(startIso, displayStr, meta){
  // meta: {service_name, service_id, professional_id}
  const serviceName = meta?.service_name || '';
  const svcId = meta?.service_id || '';
  const profId = meta?.professional_id || professionalId;

  // remove modal se já existir
  const existing = document.getElementById('wa-modal-wrap'); if(existing) existing.remove();

  const d = new Date(startIso);
  const formatted = (isNaN(d.getTime())) ? displayStr || startIso : d.toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' });

  const modal = document.createElement('div');
  modal.id = 'wa-modal-wrap';
  modal.className = 'wa-modal-backdrop';
  modal.innerHTML = `
    <div class="wa-modal" role="dialog" aria-modal="true">
      <h3 style="font-weight:600;margin-bottom:8px">Agendamento — ${formatted}</h3>
      <input id="wa_name" class="wa-input" placeholder="Seu nome" />
      <input id="wa_phone" class="wa-input" placeholder="Telefone (55119...)" inputmode="tel" />
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
        <button id="wa_cancel" class="btn btn-ghost">Cancelar</button>
        <button id="wa_whats" class="btn btn-primary">Agendar via WhatsApp</button>
        <button id="wa_book" class="btn" style="background:#10B981;color:white;border:none;border-radius:.5rem;">Reservar no site</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  document.getElementById('wa_cancel').addEventListener('click', ()=> modal.remove());

  async function tryCreateBooking(name, phone){
    try{
      const form = new FormData();
      form.append('professional_id', profId || '');
      form.append('service_id', svcId || '');
      form.append('start', startIso || '');
      form.append('client_name', name || '');
      form.append('client_phone', phone || '');

      const res = await fetch('/book/', { method:'POST', body: form });
      return res;
    }catch(err){
      console.error('create booking error', err);
      throw err;
    }
  }

  document.getElementById('wa_whats').addEventListener('click', async ()=>{
    const name = document.getElementById('wa_name').value.trim();
    const phone = document.getElementById('wa_phone').value.trim();

    if(!name && !phone){
      const ok = confirm('Você não informou nome nem telefone. Deseja abrir o WhatsApp sem registrar o agendamento no site?');
      if(!ok) return;
      const msg = `Olá! Gostaria de agendar ${serviceName || ''} no dia ${formatted}.`;
      window.open(`https://wa.me/5512991613940?text=${encodeURIComponent(msg)}`, '_blank');
      modal.remove();
      return;
    }

    try{
      const res = await tryCreateBooking(name, phone);
      if(res && res.ok){
        const data = await res.json().catch(()=>null);
        // booking criado, abrir wa.me com dados e atualizar UI
        const message = `Olá! Gostaria de agendar ${serviceName || ''} no dia ${formatted}. Nome: ${name}. Telefone: ${phone}`;
        window.open(`https://wa.me/5512991613940?text=${encodeURIComponent(message)}`, '_blank');
        if(window.showSiteToast) window.showSiteToast('Continue no WhatsApp para finalizar — reserva bloqueada no site.');
        modal.remove();
        // atualizar slots
        if(window.selectedDayIso && window.selectedServiceId){
          fetchSlots(window.selectedDayIso, window.selectedServiceId, profId);
        } else {
          setTimeout(()=>location.reload(), 800);
        }
      } else if (res && res.status === 409){
        alert('Horário já reservado por outra pessoa.');
        modal.remove();
        if(window.selectedDayIso && window.selectedServiceId){
          fetchSlots(window.selectedDayIso, window.selectedServiceId, profId);
        } else {
          location.reload();
        }
      } else {
        const text = await res.text().catch(()=>null);
        alert('Erro ao criar agendamento no site: ' + (text || res.status || 'erro'));
      }
    }catch(err){
      const ok = confirm('Ocorreu erro ao criar reserva no site. Deseja abrir o WhatsApp mesmo assim?');
      if(ok){
        const message = `Olá! Gostaria de agendar ${serviceName || ''} no dia ${formatted}. Nome: ${name}. Telefone: ${phone}`;
        window.open(`https://wa.me/5512991613940?text=${encodeURIComponent(message)}`, '_blank');
        modal.remove();
      }
    }
  });

  document.getElementById('wa_book').addEventListener('click', async ()=>{
    const name = document.getElementById('wa_name').value.trim();
    const phone = document.getElementById('wa_phone').value.trim();
    if(!name || !phone){ alert('Preencha nome e telefone para reservar no site.'); return; }

    try{
      const res = await tryCreateBooking(name, phone);
      if(res && res.ok){
        if(window.showSiteToast) window.showSiteToast('Agendamento registrado com sucesso.');
        modal.remove();
        if(window.selectedDayIso && window.selectedServiceId){
          fetchSlots(window.selectedDayIso, window.selectedServiceId, profId);
        } else {
          setTimeout(()=>location.reload(), 800);
        }
      } else if (res && res.status === 409){
        alert('Horário já reservado por outra pessoa.');
        modal.remove();
        if(window.selectedDayIso && window.selectedServiceId){
          fetchSlots(window.selectedDayIso, window.selectedServiceId, profId);
        } else {
          location.reload();
        }
      } else {
        const text = await res.text().catch(()=>null);
        alert('Erro ao criar agendamento: ' + (text || res.status || 'erro'));
      }
    }catch(err){
      alert('Erro ao conectar com o servidor: ' + (err.message || err));
    }
  });
}

/* Marcar visualmente o serviço selecionado */
document.querySelectorAll('.service-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    document.querySelectorAll('.service-item').forEach(i=>i.classList.remove('ring-2','ring-pink-300'));
    item.classList.add('ring-2','ring-pink-300');
    const radio = item.querySelector('.service-radio');
    radio.checked = true;
    window.selectedServiceId = radio.value;
    if(window.selectedDayIso) fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
  });
});

/* marcar dia clicado e solicitar slots */
document.querySelectorAll('.day-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('border-pink-600','bg-pink-50'));
    btn.classList.add('border-pink-600','bg-pink-50');
    window.selectedDayIso = btn.dataset.iso;
    if(!window.selectedServiceId){
      alert('Selecione um serviço primeiro');
      return;
    }
    fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
  });
});

/* Delegation: capturar clicks nos botões de slot (funciona mesmo com innerHTML) */
const slotsContainer = document.getElementById('slots');
slotsContainer.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-start]');
  if(!btn) return;
  const start = btn.dataset.start || btn.getAttribute('data-start-iso') || btn.getAttribute('data-start');
  const display = btn.textContent ? btn.textContent.trim() : '';
  const svcId = btn.dataset.service || window.selectedServiceId;
  const profId = btn.dataset.professional || professionalId;
  openBookingModal(start, display, { service_name: btn.dataset.serviceName || '', service_id: svcId, professional_id: profId });
});

/* fetchSlots com timeout e mensagens mais claras */
async function fetchSlots(day, serviceId, profId){
  if(!profId && !professionalId){
    document.getElementById('slots').innerHTML = '<div class="text-red-600">Nenhum profissional configurado.</div>';
    return;
  }
  const usedProf = profId || professionalId;
  const url = `/slots/?day=${encodeURIComponent(day)}&service_id=${serviceId}&professional_id=${usedProf}`;
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 8000);

  document.getElementById('slots').innerHTML = '<div class="text-gray-500">Carregando horários...</div>';

  try {
    const resp = await fetch(url, { signal: controller.signal });
    clearTimeout(timeout);
    if(resp.status === 200){
      const html = await resp.text();
      document.getElementById('slots').innerHTML = html;
    } else if (resp.status === 400){
      const text = await resp.text();
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Parâmetros inválidos: ${text}</div>`;
    } else {
      const text = await resp.text();
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários (status ${resp.status}).</div>`;
      console.error('Erro slots:', resp.status, text);
    }
  } catch (err) {
    clearTimeout(timeout);
    if (err.name === 'AbortError') {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Tempo de espera esgotado. Tente novamente.</div>`;
    } else {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários: ${err.message}</div>`;
    }
    console.error('fetchSlots error', err);
  }
}
</script>
{% endblock %}
