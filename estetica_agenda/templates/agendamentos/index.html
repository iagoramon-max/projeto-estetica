{% extends 'agendamentos/base.html' %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Serviços</h2>
    <div class="space-y-3" id="services-list">
      {% for s in services %}
      <label class="service-item block p-3 rounded-xl border hover:shadow-sm cursor-pointer flex items-center justify-between"
             data-service-id="{{ s.id }}">
        <div>
          <div class="font-medium">{{ s.name }}</div>
          <div class="text-xs text-gray-500">{{ s.duration_min }} min • R$ {{ s.price }}</div>
        </div>
        <input class="service-radio" type="radio" name="service" value="{{ s.id }}" {% if forloop.first %}checked{% endif %}>
      </label>
      {% endfor %}
    </div>
  </section>

  <!-- Calendário em grade 7 colunas (sem badge) -->
  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Escolha o dia</h2>
    <div class="grid grid-cols-7 gap-2" id="days-grid">
      {% for d in days_info %}
        <button class="day-btn p-2 rounded-lg border text-sm text-center flex flex-col items-center justify-center"
                data-iso="{{ d.iso }}"
                data-date="{{ d.date|date:'Y-m-d' }}">
          <div class="text-xs text-gray-400">{{ d.date|date:"D" }}</div>
          <div class="font-medium">{{ d.date|date:"d" }}</div>
        </button>
      {% endfor %}
    </div>
  </section>

  <!-- central confirm area (coluna do meio) -->
  <section class="p-4" id="confirm-area" style="display:block;">
    <h2 class="font-semibold text-lg mb-4">Confirmar agendamento</h2>
    <div>Horário: <strong class="confirm-start">--</strong></div>
    <div class="mt-3">
      <input name="client_name" placeholder="Nome" class="w-full p-2 border rounded mb-3" />
      <input name="client_phone" placeholder="Telefone (55119...)" class="w-full p-2 border rounded mb-3" />
      <div class="flex gap-2">
        <button id="cancel-confirm" class="px-3 py-1 border rounded">Cancelar</button>
        <button id="confirm-button" class="px-4 py-2 bg-pink-600 text-white rounded">Confirmar</button>
      </div>
    </div>
  </section>

  <section class="p-4">
    <h2 class="font-semibold text-lg mb-4">Horários</h2>
    <div id="slots" class="min-h-[220px] p-3 border rounded-lg bg-white">
      <div class="text-sm text-gray-400">Escolha um serviço e um dia para ver horários.</div>
    </div>
  </section>
</div>

<!-- hidden professional id para garantir valor numérico no JS -->
<input type="hidden" id="professional-id" value="{% if professional %}{{ professional.id }}{% endif %}" />

<script>
/* --- Estado global (exposto) --- */
window.selectedServiceId = null;
window.selectedDayIso = null;

/* inicializa selectedServiceId com o radio checado (se houver) */
const checkedService = document.querySelector('.service-radio:checked');
if (checkedService) {
  window.selectedServiceId = checkedService.value;
}

/* pega professional id de forma segura */
const professionalIdRaw = document.getElementById('professional-id')?.value || null;
const professionalId = professionalIdRaw ? professionalIdRaw : null;

/* função que abre o modal: definida aqui (global) para sempre existir */
function openBookingForm(startIso, serviceId, profId){
  const formatted = new Date(startIso).toLocaleString('pt-BR');
  const html = `
  <div id="modalWrap" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
    <div class="bg-white rounded-xl p-6 w-11/12 sm:w-96">
      <h3 class="text-lg font-semibold mb-3">Confirmar agendamento</h3>
      <div class="mb-2">Horário: <strong>${formatted}</strong></div>
      <div class="mb-2"><input id="modal-name" placeholder="Nome" class="w-full p-2 border rounded" /></div>
      <div class="mb-4"><input id="modal-phone" inputmode="tel" pattern="[0-9]*" placeholder="Telefone (55119...)" class="w-full p-2 border rounded" /></div>
      <div class="flex gap-2 justify-end">
        <button onclick="document.getElementById('modalWrap').remove()" class="px-3 py-1 border rounded">Cancelar</button>
        <button id="confirm-book" class="px-4 py-2 bg-pink-600 text-white rounded">Confirmar</button>
      </div>
    </div>
  </div>`;
  const wrapper = document.createElement('div'); wrapper.innerHTML = html; document.body.appendChild(wrapper);

  document.getElementById('confirm-book').addEventListener('click', async ()=>{
    const name = document.getElementById('modal-name').value;
    const phone = document.getElementById('modal-phone').value;
    if(!name || !phone) return alert('Preencha nome e telefone');

    // use profId (parâmetro) ou fallback global
    const prof = profId || professionalId;
    if(!prof) { alert('Profissional não configurado.'); document.getElementById('modalWrap').remove(); return; }

    const payload = new FormData();
    payload.append('professional_id', prof);
    payload.append('service_id', serviceId);
    payload.append('start', startIso);
    payload.append('client_name', name);
    payload.append('client_phone', phone);

    const resp = await fetch('/book/', { method: 'POST', body: payload });
    if(resp.status === 200){
      const data = await resp.json();
      alert('Agendamento criado!');
      // simula notificação WhatsApp
      await fetch('/notify-whatsapp/', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({booking_id: data.booking.id, to: 'professional'})
      });
      document.getElementById('modalWrap').remove();
      // recarrega os horários do dia atual
      if(window.selectedDayIso && window.selectedServiceId){
        fetchSlots(window.selectedDayIso, window.selectedServiceId, prof);
      } else {
        location.reload();
      }
    } else if(resp.status === 409){
      alert('Horário já reservado');
      document.getElementById('modalWrap').remove();
      if(window.selectedDayIso && window.selectedServiceId){
        fetchSlots(window.selectedDayIso, window.selectedServiceId, prof);
      } else {
        location.reload();
      }
    } else {
      const text = await resp.text();
      alert('Erro ao criar agendamento: ' + (text||resp.status));
      document.getElementById('modalWrap').remove();
    }
  });
}

/* Marcar visualmente o serviço selecionado */
document.querySelectorAll('.service-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    document.querySelectorAll('.service-item').forEach(i=>i.classList.remove('ring-2','ring-pink-300'));
    item.classList.add('ring-2','ring-pink-300');
    const radio = item.querySelector('.service-radio');
    radio.checked = true;
    window.selectedServiceId = radio.value;
    if(window.selectedDayIso) fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
  });
});

/* marcar dia clicado e solicitar slots */
document.querySelectorAll('.day-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('border-pink-600','bg-pink-50'));
    btn.classList.add('border-pink-600','bg-pink-50');
    window.selectedDayIso = btn.dataset.iso;
    if(!window.selectedServiceId){
      alert('Selecione um serviço primeiro');
      return;
    }
    fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
  });
});

/* Delegation: capturar clicks nos botões de slot (funciona mesmo com innerHTML) */
const slotsContainer = document.getElementById('slots');
slotsContainer.addEventListener('click', (e) => {
  const btn = e.target.closest('.slot-button');
  if(!btn) return;
  const start = btn.dataset.start;
  const serviceId = btn.dataset.service;
  const profId = btn.dataset.professional;
  // chamar modal global
  openBookingForm(start, serviceId, profId);
});

/* fetchSlots com timeout e mensagens mais claras */
async function fetchSlots(day, serviceId, profId){
  if(!profId && !professionalId){
    document.getElementById('slots').innerHTML = '<div class="text-red-600">Nenhum profissional configurado.</div>';
    return;
  }
  const usedProf = profId || professionalId;
  const url = `/slots/?day=${encodeURIComponent(day)}&service_id=${serviceId}&professional_id=${usedProf}`;
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 8000);

  document.getElementById('slots').innerHTML = '<div class="text-gray-500">Carregando horários...</div>';

  try {
    const resp = await fetch(url, { signal: controller.signal });
    clearTimeout(timeout);
    if(resp.status === 200){
      const html = await resp.text();
      document.getElementById('slots').innerHTML = html;
      // revelar a área de confirmação central e atualizar horário visível
      const confirmArea = document.getElementById('confirm-area');
      if(confirmArea) confirmArea.style.display = 'block';
    } else if (resp.status === 400){
      const text = await resp.text();
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Parâmetros inválidos: ${text}</div>`;
    } else {
      const text = await resp.text();
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários (status ${resp.status}).</div>`;
      console.error('Erro slots:', resp.status, text);
    }
  } catch (err) {
    clearTimeout(timeout);
    if (err.name === 'AbortError') {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Tempo de espera esgotado. Tente novamente.</div>`;
    } else {
      document.getElementById('slots').innerHTML = `<div class="text-red-600">Erro ao carregar horários: ${err.message}</div>`;
    }
    console.error('fetchSlots error', err);
  }
}

/* Cancel/Confirm central buttons behavior: limpar e atualizar */
document.getElementById('cancel-confirm')?.addEventListener('click', ()=>{
  // limpar e esconder
  const area = document.getElementById('confirm-area');
  if(area) { area.querySelectorAll('input').forEach(i=>i.value=''); area.style.display='none'; }
});
document.getElementById('confirm-button')?.addEventListener('click', async ()=>{
  const name = document.querySelector('input[name="client_name"]').value.trim();
  const phone = document.querySelector('input[name="client_phone"]').value.trim();
  const startText = document.querySelector('.confirm-start')?.innerText || null;
  if(!name || !phone){ alert('Preencha nome e telefone'); return; }
  if(!window.selectedDayIso || !window.selectedServiceId){ alert('Selecione dia e serviço'); return; }

  // construir start ISO: vamos reutilizar selectedDayIso e a hora do texto (se formatada)
  // mas para simplicidade assumimos que a confirmação central foi preenchida pelo modal (ou user escolheu horário)
  // então buscamos o slot que esteja marcado como "selected" no DOM
  const selectedSlot = document.querySelector('.slot-button.selected, .slot-button[aria-pressed="true"]');
  let startIso = null;
  if(selectedSlot) startIso = selectedSlot.dataset.start;
  if(!startIso){
    // fallback: compor com selectedDayIso e hora do texto
    const time = startText ? startText.split(' ')[1] : null;
    if(time) startIso = window.selectedDayIso + 'T' + time + ':00';
  }
  if(!startIso){ alert('Não foi possível identificar o horário selecionado'); return; }

  const payload = new FormData();
  payload.append('professional_id', professionalId);
  payload.append('service_id', window.selectedServiceId);
  payload.append('start', startIso);
  payload.append('client_name', name);
  payload.append('client_phone', phone);

  const resp = await fetch('/book/', { method:'POST', body: payload });
  if(resp.status === 200){
    const data = await resp.json();
    alert('Agendamento criado!');
    // notifica profissional (simulado)
    await fetch('/notify-whatsapp/', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({booking_id: data.booking.id, to: 'professional'})
    });
    // limpar e esconder
    const area = document.getElementById('confirm-area');
    if(area) { area.querySelectorAll('input').forEach(i=>i.value=''); area.style.display='none'; }
    // atualizar slots
    if(window.selectedDayIso && window.selectedServiceId) fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
    else location.reload();
  } else if(resp.status === 409){
    alert('Horário já reservado');
    if(window.selectedDayIso && window.selectedServiceId) fetchSlots(window.selectedDayIso, window.selectedServiceId, professionalId);
    else location.reload();
  } else {
    const t = await resp.text();
    alert('Erro: ' + (t || resp.status));
  }
});
</script>
{% endblock %}
