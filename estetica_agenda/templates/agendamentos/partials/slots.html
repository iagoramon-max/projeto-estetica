<div>
  <div class="text-sm text-gray-500 mb-3">Horários disponíveis</div>

  {% if slots_info|length == 0 %}
    <div class="text-sm text-gray-500">Nenhum horário disponível nesse dia (dia fechado ou expediente encerrado).</div>
  {% else %}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-2">
      {% for s in slots_info %}
        {% if s.available %}
          <button class="slot-button p-3 rounded-lg border bg-white hover:bg-pink-50 w-full text-sm text-center"
                  data-start="{{ s.start_iso }}"
                  data-display="{{ s.start|date:'d/m/Y H:i' }}"
                  data-service="{{ service.id }}"
                  data-professional="{{ professional.id }}">
            {{ s.start|date:'H:i' }}
          </button>
        {% else %}
          <button class="p-3 rounded-lg border bg-gray-100 text-gray-400 cursor-not-allowed w-full text-sm" disabled>Ocupado</button>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- Modal container (será criado dinamicamente) -->
<div id="wa-modal-root"></div>

<script>
/* Número da profissional (fixo) */
const WA_NUMBER = "5512991613940";

/* Delegation: abre modal quando um botão de horário é clicado */
document.addEventListener('click', function(e){
  const btn = e.target.closest('.slot-button');
  if(!btn) return;

  const startIso = btn.dataset.start;
  const display = btn.dataset.display;
  const serviceId = btn.dataset.service;
  const profId = btn.dataset.professional;

  openBookingModal(startIso, display, serviceId, profId);
});

/* Cria e exibe modal */
function openBookingModal(startIso, displayStr, serviceId, profId){
  // remover modal antigo se existir
  const existing = document.getElementById('wa-modal-wrap');
  if(existing) existing.remove();

  const html = `
  <div id="wa-modal-wrap" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-xl p-5 w-11/12 sm:w-[420px]">
      <h3 class="text-lg font-semibold mb-3">Agendamento — ${displayStr}</h3>

      <label class="text-xs text-gray-600">Serviço</label>
      <div id="modal-service" class="mb-3 text-sm text-gray-800">${document.querySelector('[data-service="'+serviceId+'"]') ? '' : ''}</div>

      <input id="modal-name" placeholder="Seu nome" class="w-full p-2 border rounded mb-3" />
      <input id="modal-phone" inputmode="tel" pattern="[0-9]*" placeholder="Telefone (5511...)" class="w-full p-2 border rounded mb-4" />

      <div class="flex gap-2 justify-between">
        <button id="modal-close" class="px-4 py-2 border rounded">Cancelar</button>
        <div class="flex gap-2">
          <button id="modal-whatsapp" class="px-4 py-2 bg-green-600 text-white rounded">Agendar via WhatsApp</button>
          <button id="modal-book" class="px-4 py-2 bg-pink-600 text-white rounded">Reservar no site</button>
        </div>
      </div>
    </div>
  </div>`;

  const wrapper = document.createElement('div');
  wrapper.innerHTML = html;
  document.getElementById('wa-modal-root').appendChild(wrapper);

  // preencher serviço (se houver nome visível no DOM)
  const svc = document.querySelector('.service-item input[value="'+serviceId+'"]')?.closest('.service-item')?.querySelector('div .font-medium')?.innerText;
  if(svc){
    document.getElementById('modal-service').innerText = svc;
  } else {
    document.getElementById('modal-service').innerText = '';
  }

  // evento fechar
  document.getElementById('modal-close').addEventListener('click', ()=> {
    document.getElementById('wa-modal-wrap').remove();
  });

  // evento whatsapp
  document.getElementById('modal-whatsapp').addEventListener('click', ()=> {
    const name = document.getElementById('modal-name').value || '';
    const phone = document.getElementById('modal-phone').value || '';
    let serviceName = document.getElementById('modal-service').innerText || '';
    const message = `Olá! Gostaria de agendar ${serviceName} no dia ${displayStr}. Nome: ${name}. Telefone: ${phone}`;
    const url = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
    // opcional: não fechamos o modal automaticamente (cliente pode confirmar reserva no site também)
  });

  // evento reservar no site (chama /book/)
  document.getElementById('modal-book').addEventListener('click', async ()=> {
    const name = document.getElementById('modal-name').value;
    const phone = document.getElementById('modal-phone').value;
    if(!name || !phone){
      alert('Preencha nome e telefone para reservar no site.');
      return;
    }

    const payload = new FormData();
    payload.append('professional_id', profId);
    payload.append('service_id', serviceId);
    payload.append('start', startIso);
    payload.append('client_name', name);
    payload.append('client_phone', phone);

    try {
      const resp = await fetch('/book/', { method: 'POST', body: payload });
      if(resp.status === 200){
        const data = await resp.json();
        alert('Agendamento criado no site!');
        // Notificar profissional (simulado)
        fetch('/notify-whatsapp/', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({booking_id: data.booking.id, to: 'professional'})
        }).catch(()=>{});
        // fecha modal
        document.getElementById('wa-modal-wrap').remove();
        // atualiza slots: tenta chamar fetchSlots (definido em index), se não existir faz reload
        if(window.selectedDayIso && window.selectedServiceId && typeof fetchSlots === 'function'){
          fetchSlots(window.selectedDayIso, window.selectedServiceId, profId);
        } else {
          location.reload();
        }
      } else if (resp.status === 409){
        alert('Horário já reservado por outra pessoa.');
        document.getElementById('wa-modal-wrap').remove();
        if(typeof fetchSlots === 'function') fetchSlots(window.selectedDayIso, window.selectedServiceId, profId);
      } else {
        const text = await resp.text();
        alert('Erro ao criar agendamento: ' + (text || resp.status));
      }
    } catch (err){
      alert('Erro ao conectar com o servidor: ' + err.message);
    }
  });
}
</script>
